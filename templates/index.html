<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T2å°ç« æ£€æµ‹ä¸é‰´åˆ«ç³»ç»Ÿ</title>
    <style>
        :root {
            --primary: #2563eb;
            --border: #e5e7eb;
            --bg: #f8fafc;
            --text: #111827;
            --muted: #6b7280;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        h1 {
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .upload-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .upload-options {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .btn {
            padding: 10px 20px;
            border: 1px solid var(--border);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn.primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .file-input {
            display: none;
        }
        
        .results-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .image-comparison {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .image-container {
            flex: 1;
            text-align: center;
        }
        
        .image-container img {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .stamp-results {
            display: grid;
            gap: 20px;
        }
        
        .stamp-card {
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            background: var(--bg);
        }
        
        .stamp-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .stamp-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .stamp-image {
            width: 100px;
            height: 100px;
            border-radius: 8px;
            object-fit: cover;
        }
        
        .authenticity {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .authenticity.real {
            background: #dcfce7;
            color: #166534;
        }
        
        .authenticity.fake {
            background: #fecaca;
            color: #991b1b;
        }
        
        .matches-section h3 {
            margin-bottom: 10px;
        }
        
        .matches-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }
        
        .match-item {
            text-align: center;
        }
        
        .match-image {
            width: 100px;
            height: 100px;
            border-radius: 8px;
            object-fit: cover;
            margin-bottom: 5px;
        }
        
        .similarity {
            font-size: 12px;
            color: var(--muted);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            color: var(--error);
            padding: 10px;
            background: #fef2f2;
            border-radius: 8px;
            margin: 10px 0;
        }
/* æ·»åŠ ä¸€äº›åŠ¨ç”»æ•ˆæœ */
.file-results {
    transition: all 0.3s ease;
}

.stamp-item {
    transition: transform 0.2s ease;
}

.stamp-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .stamp-info {
        flex-direction: column;
        align-items: flex-start !important;
        gap: 8px !important;
    }
    
    .stamp-tags {
        flex-wrap: wrap;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>T2å°ç« æ£€æµ‹ä¸é‰´åˆ«ç³»ç»Ÿ</h1>
            <p>ä¸Šä¼ å›¾åƒæˆ–æ–‡ä»¶å¤¹è¿›è¡Œå°ç« æ£€æµ‹ã€çœŸä¼ªé‰´åˆ«å’Œé…å‡†åˆ†æ</p>
        </header>
        
        <section class="upload-section">
            <div class="upload-options">
                <button class="btn primary" onclick="document.getElementById('imageInput').click()">
                    ä¸Šä¼ å•å¼ å›¾åƒ
                </button>
                <button class="btn" onclick="document.getElementById('folderInput').click()">
                    ä¸Šä¼ æ–‡ä»¶å¤¹
                </button>
            </div>
            
            <input type="file" id="imageInput" class="file-input" accept="image/*">
            <input type="file" id="folderInput" class="file-input" webkitdirectory multiple>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...</p>
            </div>
        </section>
        
        <section class="results-section" id="resultsSection" style="display: none;">
            <h2>åˆ†æç»“æœ</h2>
            <div id="errorMessage" class="error" style="display: none;"></div>
            
            <div class="image-comparison">
                <div class="image-container">
                    <h3>åŸå§‹å›¾åƒ</h3>
                    <img id="originalImage" alt="åŸå§‹å›¾åƒ">
                </div>
                <div class="image-container">
                    <h3>æ£€æµ‹ç»“æœ</h3>
                    <img id="resultImage" alt="æ£€æµ‹ç»“æœ">
                </div>
            </div>
            
            <div class="stamp-results" id="stampResults">
                <!-- å°ç« ç»“æœå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </section>
    </div>

    <script>
let currentBatchFiles = [];
let currentBatchIndex = 0;
let batchResults = [];
        // æ–‡ä»¶è¾“å…¥äº‹ä»¶å¤„ç†
        document.getElementById('imageInput').addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                processImage(e.target.files[0]);
            }
        });
        
        document.getElementById('folderInput').addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                processFolder(e.target.files);
            }
        });
        
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
        }
        
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'block';
        }
        
        function processImage(file) {
            showLoading();
            
            const formData = new FormData();
            formData.append('image', file);
            
            fetch('/process_image', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                
                if (data.error) {
                    showError(data.error);
                    return;
                }
                
                // æ˜¾ç¤ºç»“æœ
                document.getElementById('originalImage').src = 'data:image/png;base64,' + data.original_image;
                document.getElementById('resultImage').src = 'data:image/png;base64,' + data.result_image;
                
                // æ˜¾ç¤ºå°ç« ç»“æœ
                const stampResults = document.getElementById('stampResults');
                stampResults.innerHTML = '';
                
                data.detections.forEach(detection => {
                    const stampCard = document.createElement('div');
                    stampCard.className = 'stamp-card';
                    
                    const authenticityClass = detection.authenticity > 0.5 ? 'real' : 'fake';
                    const authenticityText = detection.authenticity > 0.5 ? 'çœŸå®' : 'ä¼ªé€ ';
                    
                    stampCard.innerHTML = `
                        <div class="stamp-header">
                            <div class="stamp-header">
        <h3>å°ç«  ${detection.stamp_id}</h3>
        <div class="stamp-info">
            <span>ç½®ä¿¡åº¦: ${(detection.confidence * 100).toFixed(1)}%</span>
            <span class="authenticity ${authenticityClass}">
                çœŸä¼ª: ${authenticityText} (${(detection.authenticity * 100).toFixed(1)}%)
            </span>
            <span style="background: #e0f2fe; color: #0369a1; padding: 2px 8px; border-radius: 12px; font-size: 12px;">
                ç»„: ${detection.registration.group} (${detection.registration.action === 'created_new' ? 'æ–°å»º' : 'å·²æœ‰'})
            </span>
        </div>
    </div>
                        <div style="display: flex; gap: 20px; align-items: flex-start;">
                            <img src="data:image/png;base64,${detection.stamp_image}" 
                                 alt="å°ç« åŒºåŸŸ" class="stamp-image">
                            <div style="flex: 1;">
                                <div class="matches-section">
                                    <h3>æœ€ç›¸ä¼¼å°ç«  (å‰${detection.matches.length}ä¸ª)</h3>
                                    <div class="matches-grid">
                                        ${detection.matches.map(match => `
                                            <div class="match-item">
                                                <img src="data:image/png;base64,${match.image}" 
                                                     alt="åŒ¹é…å°ç« " class="match-image">
                                                <div class="similarity">
                                                    ç›¸ä¼¼åº¦: ${(match.similarity * 100).toFixed(1)}%
                                                </div>
                                                <div style="font-size: 11px; color: #666;">
                                                    ${match.group}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    stampResults.appendChild(stampCard);
                });
                
                document.getElementById('resultsSection').style.display = 'block';
            })
            .catch(error => {
                hideLoading();
                showError('å¤„ç†å¤±è´¥: ' + error.message);
            });
        }
        
        function processFolder(files) {
    if (files.length > 20) {
        if (!confirm(`æ‚¨é€‰æ‹©äº† ${files.length} ä¸ªæ–‡ä»¶ï¼Œæ•°é‡è¾ƒå¤šå¯èƒ½å¯¼è‡´å¤„ç†ç¼“æ…¢ã€‚å»ºè®®åˆ†æ‰¹å¤„ç†ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ`)) {
            return;
        }
    }
    
    showLoading();
    batchResults = [];
    currentBatchFiles = Array.from(files);
    currentBatchIndex = 0;
    
    processNextBatchFile();
}

function processNextBatchFile() {
    if (currentBatchIndex >= currentBatchFiles.length) {
        // æ‰€æœ‰æ–‡ä»¶å¤„ç†å®Œæˆ
        hideLoading();
        showBatchResults();
        return;
    }
    
    const file = currentBatchFiles[currentBatchIndex];
    const formData = new FormData();
    formData.append('file', file);
    
    // æ›´æ–°åŠ è½½æç¤º
    document.querySelector('#loading p').textContent = 
        `æ­£åœ¨å¤„ç†æ–‡ä»¶ ${currentBatchIndex + 1}/${currentBatchFiles.length}: ${file.name}`;
    
    fetch('/upload_single_for_batch', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        data.filename = file.name;
        batchResults.push(data);
        currentBatchIndex++;
        
        // ç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªæ–‡ä»¶
        setTimeout(processNextBatchFile, 100); // æ·»åŠ å°å»¶è¿Ÿé¿å…é˜»å¡
    })
    .catch(error => {
        console.error('Error processing file:', file.name, error);
        batchResults.push({
            filename: file.name,
            error: error.message,
            status: 'error'
        });
        currentBatchIndex++;
        setTimeout(processNextBatchFile, 100);
    });
}
function showBatchResults() {
    const summary = {
        total: batchResults.length,
        success: batchResults.filter(r => r.status === 'success').length,
        error: batchResults.filter(r => r.status === 'error').length,
        totalStamps: batchResults.filter(r => r.status === 'success')
                        .reduce((sum, r) => sum + r.detection_count, 0),
        realStamps: batchResults.filter(r => r.status === 'success')
                        .reduce((sum, r) => sum + r.stamps.filter(s => s.authenticity_status === 'çœŸå®').length, 0),
        fakeStamps: batchResults.filter(r => r.status === 'success')
                        .reduce((sum, r) => sum + r.stamps.filter(s => s.authenticity_status === 'ä¼ªé€ ').length, 0)
    };
    
    let resultHTML = `
        <h3>ğŸ“Š æ‰¹é‡å¤„ç†å®Œæˆ</h3>
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; text-align: center;">
                <div>
                    <div style="font-size: 24px; font-weight: bold;">${summary.total}</div>
                    <div>æ€»æ–‡ä»¶æ•°</div>
                </div>
                <div>
                    <div style="font-size: 24px; font-weight: bold;">${summary.totalStamps}</div>
                    <div>æ£€æµ‹å°ç« æ•°</div>
                </div>
                <div style="color: #4ade80;">
                    <div style="font-size: 24px; font-weight: bold;">${summary.realStamps}</div>
                    <div>çœŸå®å°ç« </div>
                </div>
                <div style="color: #f87171;">
                    <div style="font-size: 24px; font-weight: bold;">${summary.fakeStamps}</div>
                    <div>ä¼ªé€ å°ç« </div>
                </div>
            </div>
        </div>
        <div class="file-results" style="max-height: 600px; overflow-y: auto;">
    `;
    
    let globalStampIndex = 1;
    
    batchResults.forEach(result => {
        if (result.status === 'success') {
            resultHTML += `
                <div style="border: 2px solid #e5e7eb; background: white; padding: 15px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 10px;">
                        <strong style="font-size: 16px; color: #374151;">ğŸ“„ ${result.filename}</strong>
                        <span style="background: #3b82f6; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px;">
                            æ£€æµ‹åˆ° ${result.detection_count} ä¸ªå°ç« 
                        </span>
                    </div>
            `;
            
            if (result.stamps.length > 0) {
                resultHTML += `<div style="margin-top: 10px;">`;
                
                result.stamps.forEach(stamp => {
                    const confidenceColor = stamp.confidence > 0.8 ? '#10b981' : 
                                          stamp.confidence > 0.5 ? '#f59e0b' : '#ef4444';
                    const authenticityColor = stamp.authenticity_status === 'çœŸå®' ? '#10b981' : '#ef4444';
                    
                    resultHTML += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; margin: 5px 0; background: #f8fafc; border-radius: 6px;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <span style="background: #6366f1; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; min-width: 60px; text-align: center;">
                                    å°ç«  ${globalStampIndex++}
                                </span>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <span style="background: ${confidenceColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;">
                                        ğŸ” ç½®ä¿¡åº¦: ${(stamp.confidence * 100).toFixed(1)}%
                                    </span>
                                    <span style="background: ${authenticityColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;">
                                        ${stamp.authenticity_status === 'çœŸå®' ? 'âœ… çœŸå®' : 'âŒ ä¼ªé€ '}: ${(stamp.authenticity_prob * 100).toFixed(1)}%
                                    </span>
                                    <span style="background: #6b7280; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;">
                                        ğŸ“ ä½ç½®: [${stamp.bbox[0]}, ${stamp.bbox[1]}, ${stamp.bbox[2]}, ${stamp.bbox[3]}]
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                resultHTML += `</div>`;
            } else {
                resultHTML += `
                    <div style="text-align: center; color: #6b7280; padding: 20px;">
                        âš ï¸ æœªæ£€æµ‹åˆ°å°ç« 
                    </div>
                `;
            }
            
            resultHTML += `</div>`;
        } else {
            resultHTML += `
                <div style="border: 2px solid #fecaca; background: #fef2f2; padding: 15px; margin: 10px 0; border-radius: 8px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="color: #dc2626; font-size: 18px;">âŒ</span>
                        <div>
                            <strong style="color: #dc2626;">${result.filename}</strong>
                            <div style="color: #b91c1c; font-size: 14px; margin-top: 5px;">${result.error}</div>
                        </div>
                    </div>
                </div>
            `;
        }
    });
    
    resultHTML += `</div>`;
    
    // æ·»åŠ å¯¼å‡ºæŒ‰é’®
    if (summary.success > 0) {
        resultHTML += `
            <div style="margin-top: 20px; text-align: center;">
                <button onclick="exportBatchResults()" class="btn primary" style="padding: 10px 20px;">
                    ğŸ“¥ å¯¼å‡ºå¤„ç†ç»“æœ
                </button>
            </div>
        `;
    }
    
    document.getElementById('resultsSection').innerHTML = resultHTML;
    document.getElementById('resultsSection').style.display = 'block';
}

// å¯¼å‡ºç»“æœåŠŸèƒ½
function exportBatchResults() {
    const exportData = {
        exportTime: new Date().toISOString(),
        summary: {
            totalFiles: batchResults.length,
            successfulFiles: batchResults.filter(r => r.status === 'success').length,
            errorFiles: batchResults.filter(r => r.status === 'error').length,
            totalStamps: batchResults.filter(r => r.status === 'success')
                            .reduce((sum, r) => sum + r.detection_count, 0),
            realStamps: batchResults.filter(r => r.status === 'success')
                            .reduce((sum, r) => sum + r.stamps.filter(s => s.authenticity_status === 'çœŸå®').length, 0),
            fakeStamps: batchResults.filter(r => r.status === 'success')
                            .reduce((sum, r) => sum + r.stamps.filter(s => s.authenticity_status === 'ä¼ªé€ ').length, 0)
        },
        results: batchResults
    };
    
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `stamp_analysis_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}
    </script>
</body>
</html>